import{V as j}from"./VisitorLayout-BEoXhik2.js";import{i as c,q as V,c as t,o as a,a as s,F as B,r as D,w as q,h as f,y as F,t as k,j as S,g as x,d as E,n as O,b as C,u as H,P as U}from"./app-DMTjTVQZ.js";import{_ as N}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{C as W,_ as G}from"./ChatForm-Bq93ZhMW.js";import"./VisitorBreadcrumbs-D33gSTMY.js";const J={class:"modal-backdrop"},K={class:"modal"},Q={class:"modal-header"},X={class:"modal-body"},Y={key:0,class:"loading-agencies"},Z={key:1,class:"agencies-list"},ee=["value"],se={key:2,class:"no-agencies"},ae={class:"modal-footer"},oe=["disabled"],ne={__name:"AgencySelectionModal",emits:["close","agency-selected"],setup($,{emit:g}){const _=g,u=c(null),m=c(!1),r=c(null),h=async()=>{m.value=!0;try{const d=await axios.get("/agencies-for-chat");u.value=d.data}catch(d){console.error("Erreur lors de la récupération des agences:",d),u.value=[]}finally{m.value=!1}},p=()=>{r.value&&_("agency-selected",r.value)};return V(()=>{h()}),(d,l)=>(a(),t("div",J,[s("div",K,[s("div",Q,[l[3]||(l[3]=s("h2",null,"Sélectionner une Agence",-1)),s("button",{onClick:l[0]||(l[0]=v=>d.$emit("close")),class:"close-button"},"×")]),s("div",X,[m.value?(a(),t("div",Y,"Chargement des agences...")):u.value&&u.value.length>0?(a(),t("div",Z,[(a(!0),t(B,null,D(u.value,v=>(a(),t("div",{key:v.id,class:"agence-card"},[s("label",null,[q(s("input",{type:"radio",name:"agence",value:v.id,"onUpdate:modelValue":l[1]||(l[1]=i=>r.value=i)},null,8,ee),[[F,r.value]]),f(" "+k(v.raison_sociale),1)])]))),128))])):(a(),t("div",se,l[4]||(l[4]=[s("p",null,"Aucune agence disponible pour le chat pour le moment.",-1)])))]),s("div",ae,[s("button",{onClick:p,disabled:!r.value,class:"start-chat-modal-button"},"Démarrer le Chat",8,oe),s("button",{onClick:l[2]||(l[2]=v=>d.$emit("close")),class:"cancel-button"},"Annuler")])])]))}},te=N(ne,[["__scopeId","data-v-479c1a28"]]),le={class:"container-grid"},ce={class:"chat-list-panel"},re={key:0,class:"rooms-list"},de=["onClick"],ie={class:"room-header"},ue={key:0,class:"agence-name"},ve={key:1,class:"no-agence-name"},ge={class:"room-details"},me={key:0,class:"last-message"},he={key:1,class:"no-messages"},_e={key:1,class:"no-rooms"},pe={class:"message-panel"},ye={key:0,class:"chat-area"},fe={class:"card"},ke={class:"card-header"},Ce={key:0},$e={key:1},Me={key:0,class:"loading-indicator"},be={class:"card-footer"},Ae={key:1,class:"no-chat-selected"},Ie={__name:"Index",props:{rooms:Array,sender:Object,initialMessages:Array},setup($){const g=$,_=c(1),u=c(g.rooms),m=c(g.sender),r=c([]),h=c(!1),p=c(null),d=c(!1),l=c(1),v=c(!1),i=c(null),y=c(null),M=o=>{i.value=o.id,y.value=o,r.value=[],l.value=1,v.value=!1,A(1,o.id),I(o.id)},R=()=>{h.value=!0},b=()=>{h.value=!1},z=o=>{b(),L(o)},L=async o=>{try{const e=await axios.post("/start-private-chat",{agence_id:o}),n=e.data.roomId;console.log("Room ID:",n),i.value=n,r.value=e.data.room.messages,l.value=1,v.value=!1,I(n)}catch(e){console.error("Erreur lors du démarrage du chat privé:",e)}},P=o=>{axios.post("/messages",{...o,roomId:i.value}).then(e=>{console.log(e.data)})},A=(o,e)=>{d.value||v.value||!e||(d.value=!0,axios.get("/messages",{params:{page:o,roomId:e}}).then(n=>{d.value=!1,n.data.length>0?(r.value=[...n.data,...r.value],l.value++):(v.value=!0,console.log("Tous les messages chargés pour cette salle"))}))},T=()=>{if(v.value||d.value||!i.value)return;const o=p.value;o.scrollHeight+o.scrollTop<560&&(console.log("Scroll en haut détecté, chargement des anciens messages..."),A(l.value+1,i.value))},I=o=>{window.Echo&&window.Echo.leaveChannel(`chat-room.${i.value}`);try{console.log("Setting up Echo listener for room:",`chat-room.${o}`),window.Echo.channel(`chat-room.${o}`).listen("ChatMessageSent",e=>{if(e.roomId===i.value){console.log("Received message:",e.message.message,"for room:",e.roomId),r.value.push({message:e.message.message,sender_id:e.sender.id,sender:e.sender}),console.log("Messages:",_.value),_.value++,console.log("Messages:",e.sender);const n=u.value.findIndex(w=>w.id===e.roomId);n>-1&&(u.value[n].messages=[e.message])}})}catch(e){console.error("Error setting up Echo listener:",e)}};return V(()=>{g.rooms&&g.rooms.length>0&&M(g.rooms[0])}),(o,e)=>(a(),S(j,null,{default:x(()=>[s("div",le,[s("aside",ce,[e[3]||(e[3]=s("h2",null,"Mes Chats Privés",-1)),s("div",{class:"new-chat-button-container"},[s("button",{onClick:R,class:"new-chat-button"},e[0]||(e[0]=[s("span",{class:"plus-icon"},"+",-1),f(" Nouvelle Conversation ")]))]),u.value&&u.value.length>0?(a(),t("div",re,[(a(!0),t(B,null,D(u.value,n=>(a(),t("div",{key:n.id,class:O(["room-card",{selected:i.value===n.id}]),onClick:w=>M(n)},[s("div",ie,[n.agence?(a(),t("h3",ue,k(n.agence.raison_sociale),1)):(a(),t("p",ve,"Agence Inconnue"))]),s("div",null,[C(H(U),{href:`/chat/${n.id}`},{default:x(()=>e[1]||(e[1]=[f("Ouvrir")])),_:2},1032,["href"])]),s("div",ge,[n.messages&&n.messages.length>0?(a(),t("p",me,' Dernier message: "'+k(n.messages[n.messages.length-1].message)+'" ',1)):(a(),t("p",he,"Aucun message dans cette salle."))])],10,de))),128))])):(a(),t("div",_e,e[2]||(e[2]=[s("p",null,"Vous n'avez pas encore de chats privés. Démarrez une conversation depuis la page d'une agence.",-1)])))]),s("main",pe,[i.value?(a(),t("div",ye,[s("div",fe,[s("div",ke,[e[4]||(e[4]=f(" Chat avec ")),y.value&&y.value.agence?(a(),t("span",Ce,k(y.value.agence.raison_sociale),1)):(a(),t("span",$e,"Agence Inconnue"))]),s("div",{class:"card-body",ref_key:"chatBody",ref:p,onScroll:T},[C(W,{messages:r.value,sender:m.value},null,8,["messages","sender"]),d.value?(a(),t("div",Me,"Chargement des messages...")):E("",!0)],544),s("div",be,[C(G,{onMessagesent:P,sender:o.$props.sender,"room-id":i.value},null,8,["sender","room-id"])])])])):(a(),t("div",Ae,e[5]||(e[5]=[s("p",null,'Cliquez sur "+ Nouvelle Conversation" pour démarrer un chat privé.',-1)])))]),h.value?(a(),S(te,{key:0,onClose:b,onAgencySelected:z})):E("",!0)])]),_:1}))}},Be=N(Ie,[["__scopeId","data-v-90b8c362"]]);export{Be as default};
