import{i as c,q as B,s as S,j as V,o as a,g as C,a as o,c as n,F as $,r as L,n as b,t as _,b as p,u as z,P as N,h as I,d as P}from"./app-DMTjTVQZ.js";import{C as R,_ as j}from"./ChatForm-Bq93ZhMW.js";import{A as D}from"./AgenceLayout-BmT00Pvm.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./VisitorBreadcrumbs-D33gSTMY.js";const T={class:"container-grid"},F={class:"chat-list-panel"},q={key:0,class:"rooms-list"},H=["onClick"],G={class:"room-header"},J={key:0,class:"agence-name"},K={key:1,class:"no-agence-name"},Q={class:"room-details"},U={key:0,class:"last-message"},W={key:1,class:"no-messages"},X={key:1,class:"no-rooms"},Y={class:"message-panel"},Z={key:0,class:"chat-area"},ee={class:"card"},se={class:"card-header"},ae={key:0},oe={key:1},ne={key:0,class:"loading-indicator"},te={class:"card-footer"},le={key:1,class:"no-chat-selected"},ce=Object.assign({layout:D},{__name:"Index",props:{rooms:Array,sender:Object,initialMessages:Array},setup(M){const d=M,i=c(d.rooms),x=c(d.sender),u=c([]),f=c(null),g=c(!1),h=c(1),m=c(!1),l=c(null),v=c(null),y=s=>{l.value=s.id,v.value=s,u.value=[],h.value=1,m.value=!1,k(1,s.id),A(s.id)},E=s=>{axios.post("/agence/messages",{...s,roomId:l.value}).then(e=>{console.log(e.data)})},k=(s,e)=>{g.value||m.value||!e||(g.value=!0,axios.get("/agence/messages",{params:{page:s,roomId:e}}).then(r=>{g.value=!1,r.data.length>0?(u.value=[...r.data,...u.value],h.value++):(m.value=!0,console.log("Tous les messages chargés pour cette salle"))}))},w=()=>{if(m.value||g.value||!l.value)return;const s=f.value;s.scrollHeight+s.scrollTop<560&&(console.log("Scroll en haut détecté, chargement des anciens messages..."),k(h.value+1,l.value))},A=s=>{window.Echo&&window.Echo.leaveChannel(`chat-room.${l.value}`);try{console.log("Setting up Echo listener for room:",`chat-room.${s}`),window.Echo.channel(`chat-room.${s}`).listen("ChatMessageSent",e=>{if(console.log("Received message:",e.message.message,"for room:",e.roomId),e.roomId===l.value){u.value.push({message:e.message.message,sender_id:e.sender.id,sender:e.sender});const r=i.value.findIndex(t=>t.id===e.roomId);r>-1&&(i.value[r].messages=[e.message])}})}catch(e){console.error("Error setting up Echo listener:",e)}};return B(()=>{d.rooms&&d.rooms.length>0&&y(d.rooms[0])}),(s,e)=>{const r=S("VisitorLayout");return a(),V(r,null,{default:C(()=>[o("div",T,[o("aside",F,[e[2]||(e[2]=o("h2",null,"Mes Chats Privés",-1)),i.value&&i.value.length>0?(a(),n("div",q,[(a(!0),n($,null,L(i.value,t=>(a(),n("div",{key:t.id,class:b(["room-card",{selected:l.value===t.id}]),onClick:re=>y(t)},[o("div",G,[t.agence?(a(),n("h3",J,_(t.agence.raison_sociale),1)):(a(),n("p",K,"Agence Inconnue"))]),o("div",Q,[t.messages&&t.messages.length>0?(a(),n("p",U,' Dernier message: "'+_(t.messages[t.messages.length-1].message)+'" ',1)):(a(),n("p",W,"Aucun message dans cette salle."))]),o("div",null,[p(z(N),{href:`/agence/chat/${t.id}`},{default:C(()=>e[0]||(e[0]=[I("Ouvrir")])),_:2},1032,["href"])])],10,H))),128))])):(a(),n("div",X,e[1]||(e[1]=[o("p",null,"Vous n'avez pas encore de chats privés. Démarrez une conversation depuis la page d'une agence.",-1)])))]),o("main",Y,[l.value?(a(),n("div",Z,[o("div",ee,[o("div",se,[e[3]||(e[3]=I(" Chat avec ")),v.value&&v.value.agence?(a(),n("span",ae,_(v.value.agence.raison_sociale),1)):(a(),n("span",oe,"Agence Inconnue"))]),o("div",{class:"card-body",ref_key:"chatBody",ref:f,onScroll:w},[p(R,{messages:u.value,sender:x.value},null,8,["messages","sender"]),g.value?(a(),n("div",ne,"Chargement des messages...")):P("",!0)],544),o("div",te,[p(j,{onMessagesent:E,sender:s.$props.sender,"room-id":l.value},null,8,["sender","room-id"])])])])):(a(),n("div",le,e[4]||(e[4]=[o("p",null,"Sélectionnez une conversation à gauche pour afficher les messages.",-1)])))])])]),_:1})}}}),ve=O(ce,[["__scopeId","data-v-0184dc0a"]]);export{ve as default};
